<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ğŸ”¥ìœ ì¹˜ë¶€ íŒ€ë³´ê³ ì„œ ì œì¶œìš©ğŸ”¥</title>
  <style>
    :root{
      --bg:#070a14; --card:#0e1733; --muted:#a9b7d7; --text:#eef3ff;
      --accent:#7aa2ff; --danger:#ff6b6b; --border: rgba(122,162,255,.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
        linear-gradient(180deg, #050712, #070a14 30%, #050712);
      color: var(--text);
      padding-bottom: 84px;
    }
    .wrap{ max-width: 920px; margin: 0 auto; padding: 18px 14px; }
    h1{ margin: 0 0 6px; font-size: 18px; }
    .sub{ margin:0 0 14px; color: var(--muted); font-size: 12.5px; line-height:1.45; }
    .pill{
      display:inline-block; padding: 4px 9px; border-radius: 999px;
      border: 1px solid rgba(169,183,215,.2);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .card{
      background: rgba(14,23,51,.92);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      margin-bottom: 12px;
    }
    .card h2{ margin:0 0 10px; font-size: 13px; color:#dbe5ff; }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.22);
      background: rgba(4,8,18,.65);
      color: var(--text);
      padding: 11px 12px;
      outline: none;
      font-size: 14px;
    }
    textarea{
      min-height: 260px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,162,255,.75);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }
    .row{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px){ .row{ grid-template-columns: 1fr 1fr; } }
    .status{ margin-top: 10px; font-size: 12px; color: var(--muted); line-height:1.45; }
    .status b{ color: #dbe5ff; }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.5; margin-top:8px; }
    details{ border-radius: 14px; overflow: hidden; }
    details > summary{
      cursor: pointer;
      list-style: none;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.18);
      background: rgba(255,255,255,.04);
      color:#dbe5ff;
      font-weight: 800;
      font-size: 13px;
    }
    details > summary::-webkit-details-marker{ display:none; }
    .actionbar{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(6,10,20,.72);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(169,183,215,.14);
    }
    .actionbar .inner{ max-width: 920px; margin: 0 auto; display:flex; gap:10px; }
    button{
      border: 0;
      border-radius: 14px;
      padding: 12px 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
      flex:1;
    }
    .primary{ background: var(--accent); color:#061028; }
    .copy{ background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(169,183,215,.22); }
    .danger{ background: rgba(255,107,107,.14); color: #ffd5d5; border: 1px solid rgba(255,107,107,.35); flex: 0 0 auto; }
    .toggleline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top: 8px; }
    .toggleline label{ margin:0; display:flex; align-items:center; gap:8px; }
    .toggleline input[type="checkbox"]{ width:auto; transform: scale(1.1); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ”¥ìœ ì¹˜ë¶€ íŒ€ë³´ê³ ì„œ ì œì¶œìš©ğŸ”¥</h1>
    <p class="sub">
      >> ì‚¬ìš© ë°©ë²•<br/>
      <span class="pill">â‘¥ ì›í•˜ëŠ” ë‚ ì§œ ë„£ê³  íŒ€ ì„ íƒ í›„</span>
      <span class="pill">â‘¦ ê°€ì ¸ì˜¤ê¸° & ìƒì„±ë²„íŠ¼ ëˆŒëŸ¬ì„œ ë³´ê³ ì„œ ìƒì„±</span>
      <span class="pill">â‘§ ë©”ì„¸ì§€ì°½ ìœ„ copyë²„íŠ¼ ëˆŒëŸ¬ ë°°í¬</span>
    <p class="sub">
         >> ë§í¬ê°€ ë°”ë€Œê±°ë‚˜ ì´ëª¨ì§€ë¥¼ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´<br/>
      <span class="pill">â‘  ë“œë¦¼/ìš°ë¦¬/ì„¬ê¹€/ì˜ˆë°° ê°ê° ì‹œíŠ¸ ë§í¬ ë¶™ì—¬ ë„£ê¸°</span>
      <span class="pill">â‘¡ ë‚ ì§œ ë„£ê³  ex)2026-01-18</span>
      <span class="pill">â‘¢ íŒ€ ì„ íƒ</span><br/>
      <span class="pill">â‘£ ì´ëª¨ì§€ë„ ë„£ì–´ì£¼ê³ </span>
      <span class="pill">â‘¤ ì„¤ì •ì €ì¥ ë²„íŠ¼ í´ë¦­(ìµœì´ˆ 1ë²ˆë§Œ)</span>
      <span class="pill">- ì´í›„ë¶€í„°ëŠ” â‘¥â‘¦ë§Œ ë°˜ë³µ</span>
    </p>
    <div class="card">
      <h2>ì„ íƒ</h2>
      <div class="row">
        <div>
          <label>ë‚ ì§œ</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>íŒ€</label>
          <select id="team">
            <option value="dream">ë“œë¦¼ë°˜</option>
            <option value="woori">ìš°ë¦¬ë°˜</option>
            <option value="serve">ì„¬ê¹€íŒ€</option>
            <option value="admin">â”” í–‰ì •íŒ€ (ì„¬ê¹€íŒ€ ì¤‘ ì¼ë¶€)</option>
            <option value="worship">ì˜ˆë°°íŒ€</option>
          </select>
        </div>
      </div>

      <div class="toggleline">
        <label><input type="checkbox" id="optIncludeNotify" checked /> â€œì „ë„ì‚¬ë‹˜ê»˜ ì•Œë¦½ë‹ˆë‹¤â€ í¬í•¨</label>
        <label><input type="checkbox" id="optAutoCopy" /> ìƒì„± í›„ ìë™ Copy</label>
      </div>

      <div class="status" id="status"></div>
    </div>

    <div class="card">
      <h2>ê²°ê³¼</h2>
      <textarea id="output" placeholder="ê°€ì ¸ì˜¤ê¸° & ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—¬ê¸° ì±„ì›Œì§‘ë‹ˆë‹¤"></textarea>
      <div class="hint">
        â€¢ Copyê°€ ì£¼ ê¸°ëŠ¥<br/>
        â€¢ ì¤‘ë³µ(ë°˜+êµì‚¬) ìµœì‹  ë®ì–´ì“°ê¸°<br/>
        â€¢ ì»¬ëŸ¼ í‚¤ì›Œë“œ ìë™ íƒìƒ‰<br/>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ì„¤ì • (ìµœì´ˆ 1íšŒ, ë˜ëŠ” ë©¤ë²„ ë³€ê²½ ì‹œ)</h2>
      <details>
        <summary>íŒ€ë³„ ì‹œíŠ¸ ë§í¬ / ì•„ì´ì½˜ / í–‰ì •íŒ€ ë©¤ë²„ ì„¤ì •</summary>
        <div style="padding-top:10px;">
          <div class="row">
            <div>
              <label>ë“œë¦¼ë°˜ ì‹œíŠ¸ ë§í¬</label>
              <input id="linkDream" placeholder="Google Sheets ë§í¬" />
            </div>
            <div>
              <label>ìš°ë¦¬ë°˜ ì‹œíŠ¸ ë§í¬</label>
              <input id="linkWoori" placeholder="Google Sheets ë§í¬" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ì„¬ê¹€íŒ€ ì‹œíŠ¸ ë§í¬ (í–‰ì •íŒ€ë„ ì—¬ê¸°ì„œ í•„í„°)</label>
              <input id="linkServe" placeholder="Google Sheets ë§í¬" />
            </div>
            <div>
              <label>ì˜ˆë°°íŒ€ ì‹œíŠ¸ ë§í¬</label>
              <input id="linkWorship" placeholder="Google Sheets ë§í¬" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ì œëª© ì•ë’¤ ì´ëª¨ì§€</label>
              <input id="titleEmoji" placeholder="ì˜ˆ: ğŸ™" />
            </div>
            <div>
              <label>ì•„ì´ì½˜(ë“œë¦¼,ìš°ë¦¬,ì„¬ê¹€,í–‰ì •,ì˜ˆë°°) ì‰¼í‘œë¡œ 5ê°œ</label>
              <input id="icons" placeholder="ì˜ˆ: ğŸŒˆ,ğŸ§¸,ğŸ¤,ğŸ—‚ï¸,ğŸµ" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ë¼ë²¨(ê¸°ë„ì œëª©, ì „ë„ì‚¬ë‹˜ê»˜) ì‰¼í‘œë¡œ 2ê°œ</label>
              <input id="labels" placeholder="ì˜ˆ: ê¸°ë„ì œëª©:, ì „ë„ì‚¬ë‹˜ê»˜:" />
            </div>
            <div>
              <label>í–‰ì •íŒ€ ë©¤ë²„(ì´ë¦„) ì‰¼í‘œë¡œ</label>
              <input id="adminMembers" placeholder="ì˜ˆ: ê¹€ìš°ì¬, ì „íš¨ë¯¼, ë°•ì›ì‹, ì´í˜œì§„" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="primary" type="button" id="btnSave" style="flex:1;">ì„¤ì • ì €ì¥</button>
            <button class="copy" type="button" id="btnLoad" style="flex:1;">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="danger" type="button" id="btnReset">ì´ˆê¸°í™”</button>
          </div>

          <div class="hint">
            â€¢ í–‰ì •íŒ€ ë©¤ë²„ê°€ ë°”ë€Œë©´ ì—¬ê¸°ì„œ ì´ë¦„ë§Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤(ì½”ë“œ ìˆ˜ì • X).<br/>
            â€¢ ì´ë¦„ì— ê³µë°±ì´ ë“¤ì–´ê°€ë„ ìë™ìœ¼ë¡œ ì •ë¦¬í•´ì„œ ë¹„êµí•©ë‹ˆë‹¤.
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="actionbar">
    <div class="inner">
      <button class="primary" id="btnFetch" type="button">ê°€ì ¸ì˜¤ê¸° & ìƒì„±</button>
      <button class="copy" id="btnCopy" type="button">Copy</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const LS_KEY = "prayer_tool_final_v2_jsonp";

    function escapeHtml(str=""){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function setStatus(msg, isError=false){
      const el = $("status");
      el.innerHTML = isError ? `âš ï¸ <b>${escapeHtml(msg)}</b>` : `âœ… <b>${escapeHtml(msg)}</b>`;
      el.style.color = isError ? "rgba(255,160,160,.95)" : "rgba(180,210,255,.95)";
    }
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function normalizeDateISO(dateStr){ return (dateStr || "").slice(0,10); }

    // "2026. 1. 4 ì˜¤í›„ 2:06:52" ê°™ì€ í•œêµ­ì–´ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì„œ
    function parseKoreanTimestampToDate(ts){
      if(ts instanceof Date) return ts;
      const s = String(ts || "").trim();
      const native = new Date(s);
      if(!Number.isNaN(native.getTime())) return native;

      const m = s.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
      if(!m) return new Date(NaN);
      const yyyy = Number(m[1]);
      const mo = Number(m[2]);
      const dd = Number(m[3]);
      const ap = m[4];
      let hh = Number(m[5]);
      const mi = Number(m[6]);
      const ss = Number(m[7] || 0);

      if(ap === "ì˜¤í›„" && hh < 12) hh += 12;
      if(ap === "ì˜¤ì „" && hh === 12) hh = 0;

      return new Date(yyyy, mo-1, dd, hh, mi, ss);
    }
    function dateOnlyISOFromTimestamp(ts){
      const d = parseKoreanTimestampToDate(ts);
      if(Number.isNaN(d.getTime())) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function formatDateKorean(dateISO){
      if(!dateISO) return "";
      const [y,m,d] = dateISO.split("-");
      return `${y}.${m}.${d}`;
    }
    function normalizeName(name){
      return String(name || "").replace(/\s+/g, "").trim();
    }

    // Settings
    function getSettings(){
      return {
        linkDream: $("linkDream").value.trim(),
        linkWoori: $("linkWoori").value.trim(),
        linkServe: $("linkServe").value.trim(),
        linkWorship: $("linkWorship").value.trim(),
        titleEmoji: ($("titleEmoji").value.trim() || "ğŸ™"),
        icons: ($("icons").value.trim() || "ğŸŒˆ,ğŸ§¸,ğŸ¤,ğŸ—‚ï¸,ğŸµ"),
        labels: ($("labels").value.trim() || "ê¸°ë„ì œëª©:, ì „ë„ì‚¬ë‹˜ê»˜:"),
        adminMembers: ($("adminMembers").value.trim() || "ê¹€ìš°ì¬, ì „íš¨ë¯¼, ë°•ì›ì‹, ì´í˜œì§„")
      };
    }
    function applySettings(s){
      $("linkDream").value = s.linkDream || "";
      $("linkWoori").value = s.linkWoori || "";
      $("linkServe").value = s.linkServe || "";
      $("linkWorship").value = s.linkWorship || "";
      $("titleEmoji").value = s.titleEmoji || "ğŸ™";
      $("icons").value = s.icons || "ğŸŒˆ,ğŸ§¸,ğŸ¤,ğŸ—‚ï¸,ğŸµ";
      $("labels").value = s.labels || "ê¸°ë„ì œëª©:, ì „ë„ì‚¬ë‹˜ê»˜:";
      $("adminMembers").value = s.adminMembers || "ê¹€ìš°ì¬, ì „íš¨ë¯¼, ë°•ì›ì‹, ì´í˜œì§„";
    }
    function saveSettings(){
      const s = getSettings();
      localStorage.setItem(LS_KEY, JSON.stringify(s));
      setStatus("ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
    }
    function loadSettings(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        applySettings({});
        setStatus("ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
        return;
      }
      try{
        applySettings(JSON.parse(raw));
        setStatus("ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
      }catch(e){
        applySettings({});
        setStatus("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(ì €ì¥ê°’ ì†ìƒ).", true);
      }
    }
    function resetSettings(){
      localStorage.removeItem(LS_KEY);
      applySettings({});
      setStatus("ì„¤ì •ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    }

    function parseIcons(iconsStr){
      const parts = String(iconsStr||"").split(",").map(x=>x.trim()).filter(Boolean);
      const fallback = ["ğŸŒˆ","ğŸ§¸","ğŸ¤","ğŸ—‚ï¸","ğŸµ"];
      const arr = [];
      for(let i=0;i<5;i++) arr[i] = parts[i] || fallback[i];
      return { dream:arr[0], woori:arr[1], serve:arr[2], admin:arr[3], worship:arr[4] };
    }
    function parseLabels(labelsStr){
      const parts = String(labelsStr||"").split(",").map(x=>x.trim()).filter(Boolean);
      return { prayer: parts[0] || "ê¸°ë„ì œëª©:", notify: parts[1] || "ì „ë„ì‚¬ë‹˜ê»˜:" };
    }
    function parseAdminMembers(str){
      return new Set(
        String(str||"").split(",").map(x=>normalizeName(x)).filter(Boolean)
      );
    }

    // --- Google Sheets: JSONP (CORS íšŒí”¼)
    function parseSheetLink(link){
      if(!link) return null;
      // sheet id
      const m = link.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if(!m) return null;
      const id = m[1];
      const gidM = link.match(/gid=([0-9]+)/);
      const gid = gidM ? gidM[1] : null; // optional
      return { id, gid };
    }

    function jsonp(url, { timeoutMs = 15000 } = {}){
      return new Promise((resolve, reject) => {
        const cb = "__pt_cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("ì‹œê°„ ì´ˆê³¼: ì‹œíŠ¸ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤(ê³µìœ  ì„¤ì •/ë„¤íŠ¸ì›Œí¬ í™•ì¸)."));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cb]; }catch(_){}
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cb] = (data) => { cleanup(); resolve(data); };

        script.onerror = () => {
          cleanup();
          reject(new Error("ë¡œë“œ ì‹¤íŒ¨: ì‹œíŠ¸ê°€ ë¹„ê³µê°œì´ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬/CORS ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤(ê³µìœ : ë§í¬ ë³´ê¸° í•„ìš”)."));
        };

        // gviz supports responseHandler
        const joiner = url.includes("?") ? "&" : "?";
        script.src = url + joiner + "tqx=" + encodeURIComponent(`out:json;responseHandler:${cb}`);
        document.head.appendChild(script);
      });
    }

    async function fetchSheetRows(link){
      const info = parseSheetLink(link);
      if(!info) throw new Error("ì‹œíŠ¸ ë§í¬ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      // gidê°€ ìˆìœ¼ë©´ ë„£ì–´ì„œ íŠ¹ì • ì‹œíŠ¸ë¥¼ ë³´ì¥
      const gidParam = info.gid ? `&gid=${encodeURIComponent(info.gid)}` : "";
      const base = `https://docs.google.com/spreadsheets/d/${info.id}/gviz/tq?${gidParam ? gidParam.slice(1) : ""}`;

      const data = await jsonp(base);
      // ì‘ë‹µì´ ë¡œê·¸ì¸ í˜ì´ì§€/ì—ëŸ¬ì´ë©´ tableì´ ì—†ìŒ
      if(!data || !data.table) throw new Error("ì‹œíŠ¸ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤(ê³µìœ  ì„¤ì • í™•ì¸: ë§í¬ ìˆëŠ” ì‚¬ìš©ì ë³´ê¸°).");

      const headers = (data.table.cols || []).map(c => (c.label || "").trim() || "");
      const rows = (data.table.rows || []).map(r => (r.c || []).map(cell => cell ? (cell.f ?? cell.v ?? "") : ""));
      return [headers, ...rows];
    }

    // Fixed columns from screenshot:
    // A: timestamp(0), B: name(1), F: prayer(5), G: notify(6)
    function rowsToEntriesFixed(rows){
      if(!rows || rows.length < 2) return [];
      return rows.slice(1)
        .filter(r => r && r.some(v => String(v||"").trim() !== ""))
        .map(r => {
          const tsRaw = r[0] ?? "";
          const name = String(r[1] ?? "").trim() || "ìµëª…";
          const prayer = String(r[5] ?? "").trim();
          const notify = String(r[6] ?? "").trim();
          const d = parseKoreanTimestampToDate(tsRaw);
          const tsMs = Number.isNaN(d.getTime()) ? 0 : d.getTime();
          const dateISO = dateOnlyISOFromTimestamp(tsRaw);
          return { dateISO, tsMs, name, prayer, notify };
        })
        .filter(e => (e.prayer && e.prayer.trim()) || (e.notify && e.notify.trim()));
    }
    
    // ìš°ë¦¬/ë“œë¦¼ë°˜ ì „ìš© ì»¬ëŸ¼:
    // A: timestamp(0), B: ë°˜ì´ë¦„(1), C: ì´ë¦„(2), G: ì˜ˆê¼¬ê¸°ë„(6), I: êµì‚¬ê¸°ë„(8)
    function rowsToEntriesWooriDream(rows){
      if(!rows || rows.length < 2) return [];
      return rows.slice(1)
        .filter(r => r && r.some(v => String(v||"").trim() !== ""))
        .map(r => {
          const tsRaw = r[0] ?? "";
          const className = String(r[1] ?? "").trim();      // ë°˜ì´ë¦„
          const name = String(r[2] ?? "").trim() || "ìµëª…"; // êµì‚¬ ì´ë¦„
          const childPrayer = String(r[6] ?? "").trim();    // ì˜ˆê¼¬ ê¸°ë„ì œëª©
          const teacherPrayer = String(r[8] ?? "").trim();  // êµì‚¬ ê¸°ë„ì œëª©
          const d = parseKoreanTimestampToDate(tsRaw);
          const tsMs = Number.isNaN(d.getTime()) ? 0 : d.getTime();
          const dateISO = dateOnlyISOFromTimestamp(tsRaw);
          return { dateISO, tsMs, className, name, childPrayer, teacherPrayer };
        })
        .filter(e => (e.childPrayer && e.childPrayer.trim()) || (e.teacherPrayer && e.teacherPrayer.trim()));
    }

function filterByDate(entries, targetDateISO){
      return entries.filter(e => e.dateISO === targetDateISO);
    }

    
    // ìš°ë¦¬/ë“œë¦¼ë°˜ ì „ìš© ì¶œë ¥
    // - ì²« ì¤„: [íŒ€ì´ëª¨ì§€][ë°˜ì´ë¦„][titleEmoji][ì´ë¦„] (ê³µë°± ì—†ì´)
    // - ë‹¤ìŒ ì¤„: ğŸ§’ ì˜ˆê¼¬: + ì˜ˆê¼¬ê¸°ë„(ì—¬ëŸ¬ ì¤„ì€ ê·¸ëŒ€ë¡œ)
    // - ë‹¤ìŒ ì¤„: ğŸ‘©â€ êµì‚¬: + êµì‚¬ê¸°ë„(ì—¬ëŸ¬ ì¤„ì€ ê·¸ëŒ€ë¡œ)
    // - ì‚¬ëŒê³¼ ì‚¬ëŒ ì‚¬ì´: ë¹ˆ ì¤„ 1ì¤„
    function buildMessageWooriDream({teamKey, dateISO, entries, icons, titleEmoji}){
      const teamNameMap = { dream:"ë“œë¦¼ë°˜", woori:"ìš°ë¦¬ë°˜" };
      const teamName = teamNameMap[teamKey] || teamKey;
      const icon = icons[teamKey] || "ğŸ™";
      const dateText = formatDateKorean(dateISO);
      const mid = titleEmoji || "ğŸ™";

      // ë°˜ ìˆœì„œ(1~9)ëŒ€ë¡œ ì •ë ¬, ê°™ì€ ë°˜ ì•ˆì—ì„œëŠ” ìµœì‹ ìˆœ
      function _classNum(s){
        const m = String(s||"").match(/(\d+)/);
        return m ? parseInt(m[1], 10) : 999;
      }
      const sorted = [...entries].sort((a,b)=>{
        const na = _classNum(a.className);
        const nb = _classNum(b.className);
        if(na !== nb) return na - nb;              // 1ë°˜ â†’ 9ë°˜
        return (b.tsMs||0) - (a.tsMs||0);          // ê°™ì€ ë°˜ì´ë©´ ìµœì‹ ìˆœ
      });

      const lines = [];
      lines.push(`${dateText}`);
      lines.push(`${mid} ${teamName} ê¸°ë„ì œëª© ${mid}`);
      lines.push("");

      for(let i=0;i<sorted.length;i++){
        const e = sorted[i];
        const cls = String(e.className || "").replace(/\s+/g, "");
        lines.push(`${icon}${cls}${mid}${e.name}`);

        lines.push("ğŸ§’ ì˜ˆê¼¬:");
        const childLines = String(e.childPrayer||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")
          .split("\n").map(x=>x.trim()).filter(Boolean);
        for(const l of childLines) lines.push(l);

        lines.push("ğŸ‘©â€ êµì‚¬:");
        const teacherLines = String(e.teacherPrayer||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")
          .split("\n").map(x=>x.trim()).filter(Boolean);
        for(const l of teacherLines) lines.push(l);

        if(i !== sorted.length - 1) lines.push("");
      }
      return lines.join("\n");
    }

function buildMessage({teamKey, dateISO, entries, icons, titleEmoji, includeNotify, labels}){
      const teamNameMap = { dream:"ë“œë¦¼ë°˜", woori:"ìš°ë¦¬ë°˜", serve:"ì„¬ê¹€íŒ€", admin:"í–‰ì •íŒ€", worship:"ì˜ˆë°°íŒ€" };
      const teamName = teamNameMap[teamKey] || teamKey;
      const icon = icons[teamKey] || "ğŸ™";
      const dateText = formatDateKorean(dateISO);
      const tEmoji = titleEmoji || "ğŸ™";

      const sorted = [...entries].sort((a,b)=>(b.tsMs||0)-(a.tsMs||0));
      const prayers = sorted.filter(e => (e.prayer||"").trim().length > 0);
      const notifies = sorted
        .map(e => ({ name: e.name, notify: (e.notify||"").trim() }))
        .filter(x => includeNotify && x.notify.length > 0);

      const lines = [];
      lines.push(`${dateText}`);
      lines.push(`${tEmoji} ${teamName} ê¸°ë„ì œëª© ${tEmoji}`);
      lines.push("");

      lines.push(`- ${labels.prayer}`);
         if(prayers.length){
        for(const e of prayers){
          const p = e.prayer.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
          const pLines = p.split("\n").map(x=>x.trim()).filter(Boolean);
          if(pLines.length <= 0){
            lines.push(`${icon} ${e.name} ${pLines[0] || ""}`.trim());
          }else{
            lines.push("");
            lines.push(`${icon} ${e.name}`);
            for(const pl of pLines) lines.push(`${pl}`);
          }
        }
      }else{
        lines.push("  â€¢ (í•´ë‹¹ ë‚ ì§œ ì‘ë‹µ ì—†ìŒ)");
      }

      if(includeNotify){
        lines.push("");
        lines.push(`- ${labels.notify}`);
        if(notifies.length){
          for(const n of notifies){
            const t = n.notify.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
            const tLines = t.split("\n").map(x=>x.trim()).filter(Boolean);
            if(tLines.length <= 1){
              lines.push(`  â€¢ ${n.name}: ${tLines[0] || ""}`.trim());
            }else{
              lines.push(`  â€¢ ${n.name}:`);
              for(const tl of tLines) lines.push(`    - ${tl}`);
            }
          }
        }else{
          lines.push("  â€¢ (ë‚´ìš© ì—†ìŒ)");
        }
      }
      return lines.join("\n");
    }

    function teamLink(settings, teamKey){
      // í–‰ì •íŒ€ì€ ì„¬ê¹€íŒ€ ì‹œíŠ¸ì—ì„œ í•„í„°ë§
      if(teamKey === "admin") return (settings.linkServe || "").trim();
      const map = { dream:settings.linkDream, woori:settings.linkWoori, serve:settings.linkServe, worship:settings.linkWorship };
      return (map[teamKey] || "").trim();
    }

    async function copyToClipboard(text){
      if(!text.trim()) throw new Error("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        $("output").focus();
        $("output").select();
        const ok = document.execCommand("copy");
        if(!ok) throw e;
        return true;
      }
    }

    async function handleFetch(){
      const settings = getSettings();
      const dateISO = normalizeDateISO($("date").value);
      const teamKey = $("team").value;
      const includeNotify = $("optIncludeNotify").checked;
      const autoCopy = $("optAutoCopy").checked;

      if(!dateISO){ setStatus("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", true); return; }

      const link = teamLink(settings, teamKey);
      if(!link){ setStatus("ì„ íƒí•œ íŒ€ì˜ ì‹œíŠ¸ ë§í¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤(ì„¤ì •ì—ì„œ ì…ë ¥).", true); return; }

      const icons = parseIcons(settings.icons);
      const labels = parseLabels(settings.labels);
      const adminSet = parseAdminMembers(settings.adminMembers);

      $("output").value = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      setStatus("ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

      try{
        const rows = await fetchSheetRows(link);

        let entries = [];
        let msg = "";

        // ìš°ë¦¬/ë“œë¦¼ë°˜ì€ ì»¬ëŸ¼ê³¼ ì¶œë ¥ í¬ë§·ì´ ë‹¤ë¦„
        if(teamKey === "woori" || teamKey === "dream"){
          const entriesAllW = rowsToEntriesWooriDream(rows);
          entries = filterByDate(entriesAllW, dateISO);

          msg = buildMessageWooriDream({
            teamKey, dateISO, entries, icons,
            titleEmoji: settings.titleEmoji
          });
        } else {
          const entriesAll = rowsToEntriesFixed(rows);
          entries = filterByDate(entriesAll, dateISO);

          if(teamKey === "admin"){
            entries = entries.filter(e => adminSet.has(normalizeName(e.name)));
          }

          msg = buildMessage({
            teamKey, dateISO, entries, icons,
            titleEmoji: settings.titleEmoji,
            includeNotify, labels
          });
        }
        $("output").value = msg;
        setStatus(`ìƒì„± ì™„ë£Œ: ${entries.length}ê±´`);
        if(autoCopy){
          await copyToClipboard(msg);
          setStatus(`ìƒì„± ì™„ë£Œ + ìë™ Copy (${entries.length}ê±´)`);
        }
      }catch(e){
        $("output").value = "";
        setStatus(e.message || String(e), true);
      }
    }

    async function handleCopy(){
      try{
        await copyToClipboard($("output").value);
        setStatus("í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        setStatus("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œ/ë³´ì•ˆ(HTTPS) í™•ì¸", true);
      }
    }

    $("btnFetch").addEventListener("click", handleFetch);
    $("btnCopy").addEventListener("click", handleCopy);
    $("btnSave").addEventListener("click", () => saveSettings());
    $("btnLoad").addEventListener("click", () => loadSettings());
    $("btnReset").addEventListener("click", () => resetSettings());

    $("date").value = todayISO();
    loadSettings();
  </script>
</body>
</html>
